<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVA Admin - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Background Aurora Animation -->
  <div class="background-aura">
    <div class="aura-blob aura-1"></div>
    <div class="aura-blob aura-2"></div>
  </div>

  <div class="app-container">
    
    <!-- Glass Header -->
    <header class="glass-header">
      <div class="logo-section">
        <div class="logo-icon">
          <!-- Shield Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <div class="logo-text">
          EVA <span class="badge">Admin</span>
        </div>
      </div>
      <button id="logoutBtn" class="btn btn-text">
        Log out
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
      <div class="refresh-status">
        <span id="lastUpdated" class="status-time">Updating...</span>
      </div>
    </header>

    <main class="dashboard-grid">
      
      <!-- Top Row: Stats and Send Notification -->
      <div class="top-section">
        <!-- Stats Column -->
        <div class="stats-column">
          <section class="stat-card card">
            <div class="stat-icon-bg">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Total Users</div>
              <h3 id="totalUsers">0</h3>
            </div>
          </section>

          <section class="stat-card card">
            <div class="stat-icon-bg">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            </div>
            <div class="stat-content">
              <div class="stat-label">Push Subscribers</div>
              <h3 id="totalSubscribers">0</h3>
            </div>
          </section>
        </div>

        <!-- Send Notification Column -->
        <section class="card notification-form-card">
          <div class="card-header">
            <div class="icon-circle">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </div>
            <h2>Send Notification</h2>
          </div>
          <p class="card-subtitle">Broadcast a message to all users.</p>
          
          <form id="notificationForm" class="modern-form">
            <div class="form-group">
              <label for="notifTitle">Title</label>
              <input type="text" id="notifTitle" name="title" required placeholder="e.g. EVA App Now Live" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="notifBody">Message</label>
              <textarea id="notifBody" name="body" required rows="4" placeholder="Write your notification content here..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">
              Send Notification
            </button>
          </form>
          <div id="sendStatus" class="status-message"></div>
        </section>
      </div>

      <!-- Users Table - Full Width -->
      <section class="card users-table-card">
          <div class="card-header">
            <div class="icon-circle">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <h2>Users</h2>
            <!-- Export Button -->
            <div style="margin-left: auto;">
              <button onclick="exportUsersToExcel()" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export to Excel
              </button>
            </div>
          </div>
          <p class="card-subtitle">All registered users with subscription status.</p>

          <!-- Search and Filter Row -->
          <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
            <input type="text" id="userSearch" placeholder="Search by name or email..." style="flex: 1; padding: 10px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px;" />
            <button onclick="searchUsers()" class="btn btn-secondary" style="white-space: nowrap;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
              Search
            </button>
          </div>

          <!-- Filter Tabs -->
          <div class="filter-tabs">
            <button class="tab-btn active" data-filter="all" onclick="filterUsers('all')">All Users (<span id="allUsersCount">0</span>)</button>
            <button class="tab-btn" data-filter="subscribed" onclick="filterUsers('subscribed')">Subscribed (<span id="subscribedCount">0</span>)</button>
            <button class="tab-btn" data-filter="unsubscribed" onclick="filterUsers('unsubscribed')">Unsubscribed (<span id="unsubscribedCount">0</span>)</button>
          </div>

          <div class="table-responsive">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Status</th>
                  <th>Device</th>
                  <th>Registered</th>
                </tr>
              </thead>
              <tbody id="usersBody">
                <tr><td colspan="4" class="text-center text-muted" style="padding: 40px;">Loading users...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-container" id="userPagination" style="display: none;">
            <div class="pagination-info">
              <span id="paginationInfo">Showing 0-0 of 0</span>
            </div>
            <div class="pagination-controls">
              <button onclick="changePage('prev')" id="prevBtn" class="btn btn-secondary" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                Previous
              </button>
              <span id="pageNumbers" style="display: flex; gap: 4px; align-items: center;"></span>
              <button onclick="changePage('next')" id="nextBtn" class="btn btn-secondary">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const API_URL = '<%= apiUrl %>';  // Use server-provided API URL
    const token = localStorage.getItem('adminToken');
    let refreshInterval;
    let lastUpdateTime = new Date();
    let allUsers = []; // Store all users data
    let currentFilter = 'all'; // Current filter state
    let currentPage = 1;
    let totalPages = 1;
    let totalUsers = 0;
    let searchTerm = '';

    if (!token) {
      window.location.href = '/login';
    }

    // Check if password change is required
    async function checkFirstLogin() {
      try {
        // Retry logic for network resilience
        let retries = 3;
        while (retries > 0) {
          try {
            const response = await fetch(`${API_URL}/api/admin/auth/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
              const data = await response.json();
              if (data.admin.mustChangePassword) {
                window.location.href = '/change-password';
              }
              return; // Success, exit retry loop
            } else if (response.status === 401) {
              localStorage.removeItem('adminToken');
              window.location.href = '/login';
              return;
            } else {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          } catch (error) {
            retries--;
            if (retries === 0) throw error; // No more retries, rethrow
            console.warn(`Retrying admin check (${3 - retries}/3)...`);
            await new Promise(resolve => setTimeout(resolve, 500)); // 500ms delay
          }
        }
      } catch (error) {
        console.error('Error checking first login status:', error);
        // Don't redirect on network errors to prevent redirect loops
        // User will see stale data but can manually refresh
      }
    }

    // Check on page load
    checkFirstLogin();

    // --- Helper to get initials for avatar ---
    function getInitials(name) {
      return name ? name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase() : 'U';
    }

    // --- Update timestamp ---
    function updateTimestamp() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('lastUpdated').textContent = `Last updated: ${time}`;
    }

    // --- Load Subscribers (Real-time) ---
    async function loadSubscribers() {
      try {
        const response = await fetch(`${API_URL}/api/notifications/admin/subscriptions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('adminToken');
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load subscribers');
        }

        const data = await response.json();
        displaySubscribers(data.subscriptions);
        document.getElementById('totalSubscribers').textContent = data.total;
        updateTimestamp();
      } catch (error) {
        console.error('Error loading subscribers:', error);
        document.getElementById('subscribersBody').innerHTML = 
          '<tr><td colspan="3" class="text-center text-muted">Error loading data</td></tr>';
      }
    }

    // --- Load All Users (Real-time) ---
    async function loadUsers(page = 1) {
      try {
        const limit = 50;
        const url = `${API_URL}/api/notifications/admin/users?page=${page}&limit=${limit}&search=${encodeURIComponent(searchTerm)}`;
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('adminToken');
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load users');
        }

        const data = await response.json();
        allUsers = data.users;
        currentPage = data.page;
        totalPages = data.totalPages;
        totalUsers = data.total;
        
        document.getElementById('totalUsers').textContent = totalUsers;
        
        // Update filter counts (need to fetch separately for accurate counts)
        updateFilterCounts();
        
        // Display users based on current filter
        displayUsers(allUsers);
        updatePagination();
        updateTimestamp();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersBody').innerHTML = 
          '<tr><td colspan="4" class="text-center text-muted">Error loading data</td></tr>';
      }
    }

    // Update filter counts
    async function updateFilterCounts() {
      const subscribedCount = allUsers.filter(u => u.isSubscribed).length;
      const unsubscribedCount = allUsers.filter(u => !u.isSubscribed).length;
      document.getElementById('allUsersCount').textContent = totalUsers;
      document.getElementById('subscribedCount').textContent = subscribedCount;
      document.getElementById('unsubscribedCount').textContent = unsubscribedCount;
    }

    // Search users
    function searchUsers() {
      searchTerm = document.getElementById('userSearch').value;
      currentPage = 1;
      loadUsers(currentPage);
    }

    // Handle Enter key in search
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('userSearch');
      if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchUsers();
          }
        });
      }
    });

    // Change page
    function changePage(direction) {
      if (direction === 'prev' && currentPage > 1) {
        loadUsers(currentPage - 1);
      } else if (direction === 'next' && currentPage < totalPages) {
        loadUsers(currentPage + 1);
      } else if (typeof direction === 'number') {
        loadUsers(direction);
      }
    }

    // Update pagination UI
    function updatePagination() {
      const paginationContainer = document.getElementById('userPagination');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageNumbers = document.getElementById('pageNumbers');
      const paginationInfo = document.getElementById('paginationInfo');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';
      
      // Update buttons
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      // Update info
      const start = (currentPage - 1) * 50 + 1;
      const end = Math.min(currentPage * 50, totalUsers);
      paginationInfo.textContent = `Showing ${start}-${end} of ${totalUsers}`;

      // Generate page numbers
      pageNumbers.innerHTML = '';
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'btn btn-secondary page-number-btn';
        if (i === currentPage) {
          btn.classList.add('active');
        }
        btn.onclick = () => changePage(i);
        pageNumbers.appendChild(btn);
      }
    }

    // --- Filter Users ---
    function filterUsers(filter) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });
      
      // Filter and display users
      let filteredUsers = allUsers;
      if (filter === 'subscribed') {
        filteredUsers = allUsers.filter(u => u.isSubscribed);
      } else if (filter === 'unsubscribed') {
        filteredUsers = allUsers.filter(u => !u.isSubscribed);
      }
      
      displayUsers(filteredUsers);
    }

    function displayUsers(users) {
      const tbody = document.getElementById('usersBody');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted" style="padding: 40px;">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const name = user.name || 'Unknown User';
        const email = user.email || 'No Email';
        const initials = getInitials(name);
        const date = new Date(user.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const isSubscribed = user.isSubscribed;
        const deviceType = user.subscription?.deviceType || 'N/A';
        
        return `
        <tr>
          <td>
            <div class="user-cell">
              <div class="avatar-placeholder">${initials}</div>
              <div class="user-info">
                <span class="user-name">${name}</span>
                <span class="user-email">${email}</span>
              </div>
            </div>
          </td>
          <td>
            <span class="badge-status ${isSubscribed ? 'subscribed' : 'unsubscribed'}">
              ${isSubscribed ? '✓ Subscribed' : '✗ Not Subscribed'}
            </span>
          </td>
          <td>
            ${isSubscribed ? `<span class="badge-device">${deviceType}</span>` : '<span class="text-muted" style="font-size: 13px;">—</span>'}
          </td>
          <td style="color: #6B7280; font-size: 13px;">${date}</td>
        </tr>
      `}).join('');
    }

    function displaySubscribers(subscriptions) {
      const tbody = document.getElementById('subscribersBody');
      
      if (!subscriptions || subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted" style="padding: 40px;">No subscribers found</td></tr>';
        return;
      }

      tbody.innerHTML = subscriptions.map(sub => {
        const name = sub.userId?.name || 'Unknown User';
        const email = sub.userId?.email || 'No Email';
        const initials = getInitials(name);
        const date = new Date(sub.subscribedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        return `
        <tr>
          <td>
            <div class="user-cell">
              <div class="avatar-placeholder">${initials}</div>
              <div class="user-info">
                <span class="user-name">${name}</span>
                <span class="user-email">${email}</span>
              </div>
            </div>
          </td>
          <td>
             <span class="badge-device">${sub.deviceType || 'Mobile'}</span>
          </td>
          <td style="color: #6B7280; font-size: 13px;">${date}</td>
        </tr>
      `}).join('');
    }

    // --- Export Users to Excel ---
    function exportUsersToExcel() {
      if (!allUsers || allUsers.length === 0) {
        alert('No users to export');
        return;
      }

      // Filter users based on current filter
      let usersToExport = allUsers;
      if (currentFilter === 'subscribed') {
        usersToExport = allUsers.filter(u => u.isSubscribed);
      } else if (currentFilter === 'unsubscribed') {
        usersToExport = allUsers.filter(u => !u.isSubscribed);
      }

      // Prepare data for Excel
      const excelData = usersToExport.map(user => ({
        'Name': user.name || 'N/A',
        'Email': user.email || 'N/A',
        'Status': user.isSubscribed ? 'Subscribed' : 'Not Subscribed',
        'Device': user.subscription?.deviceType || 'N/A',
        'Registered Date': new Date(user.createdAt).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })
      }));

      // Create workbook and worksheet
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Users');

      // Generate filename with current filter and date
      const filterName = currentFilter === 'all' ? 'All_Users' : 
                         currentFilter === 'subscribed' ? 'Subscribed_Users' : 'Unsubscribed_Users';
      const timestamp = new Date().toISOString().split('T')[0];
      const filename = `EVA_${filterName}_${timestamp}.xlsx`;

      // Download the file
      XLSX.writeFile(wb, filename);
    }

    // --- Export Subscribers to Excel ---
    function exportSubscribersToExcel() {
      const subscribersTable = document.getElementById('subscribersTable');
      if (!subscribersTable) {
        alert('No subscribers table found');
        return;
      }

      // Get all subscriber rows
      const rows = subscribersTable.querySelectorAll('tbody tr');
      if (rows.length === 0 || rows[0].cells.length === 1) {
        alert('No subscribers to export');
        return;
      }

      const excelData = [];
      rows.forEach(row => {
        if (row.cells.length >= 3) {
          const name = row.cells[0].querySelector('.user-name')?.textContent || 'N/A';
          const email = row.cells[0].querySelector('.user-email')?.textContent || 'N/A';
          const device = row.cells[1].textContent.trim();
          const subscribed = row.cells[2].textContent.trim();
          
          excelData.push({
            'Name': name,
            'Email': email,
            'Device': device,
            'Subscribed Date': subscribed
          });
        }
      });

      if (excelData.length === 0) {
        alert('No subscriber data to export');
        return;
      }

      // Create workbook and worksheet
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Subscribers');

      // Generate filename with date
      const timestamp = new Date().toISOString().split('T')[0];
      const filename = `EVA_Push_Subscribers_${timestamp}.xlsx`;

      // Download the file
      XLSX.writeFile(wb, filename);
    }

    // --- Send Notification ---
    document.getElementById('notificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('notifTitle').value;
      const body = document.getElementById('notifBody').value;
      const statusEl = document.getElementById('sendStatus');

      try {
        statusEl.textContent = 'Sending broadcast...';
        statusEl.className = 'status-message loading';
        statusEl.style.display = 'block';

        const response = await fetch(`${API_URL}/api/notifications/admin/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, body })
        });

        const data = await response.json();

        if (response.ok) {
          statusEl.textContent = `Success: ${data.message}`;
          statusEl.className = 'status-message success';
          e.target.reset();
          loadSubscribers(); // Refresh on successful send
          loadUsers(); // Refresh users too
          setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        } else {
          statusEl.textContent = `Error: ${data.message}`;
          statusEl.className = 'status-message error';
        }
      } catch (error) {
        statusEl.textContent = 'Failed to connect to server';
        statusEl.className = 'status-message error';
      }
    });

    // --- Logout ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('adminToken');
      window.location.href = '/login';
    });

    // --- Init with Real-time Updates ---
    loadSubscribers();
    loadUsers();
    refreshInterval = setInterval(() => {
      loadSubscribers();
      loadUsers();
    }, 10000); // Poll every 10s for real-time feel
  </script>
</body>
</html>